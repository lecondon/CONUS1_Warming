---
title: "Analysis and Figures for CONUS Warming Paper"
author: "Laura Condon"
output:
  html_document: default
  pdf_document: default
---

```{r setup, cache=FALSE,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="/Users/laura/Documents/CONUS/Warming_Runs")

#install.packages('rgdal')
rm(list=ls())
library(raster)
library(maptools)
library(fields)
library(RColorBrewer)
library(rgdal)

source("~/Documents/R_Functions/PFB-ReadFcn.R")

plotdir="./Figures_December18/"
dir="./Simulation_Averages"
```

## General setup
Setting up domain variables
```{r domain_setup}
runlist=c(0,1.5, 2,4)
ylist=4:7
nyear=length(ylist)
nrun=length(runlist)

varlist=c("storage", "LH")

#Domain info 
nx=3342
ny=1888
nval=nx*ny

#make xy arrays
ncell=nx*ny
x=rep(1:nx, ny)
y=rep(1:ny, each=nx)

#Making xy vectors with the UTM coordinates
xll=-1884563.7545319
yll= -605655.0023757
xUTM=x*1000+xll
yUTM=y*1000+yll

# Latent Heat of vaporization 
lvap= 2.5104*10^6 # J/kg n- this is the value for 'hvap' in pfsimulator/clm/clm_varcon.F90 
#to convert from W/m2 to mm/hr
# w/m2= J/(s*m2) 
# LH (j/(s*m2)) / lvap (J/kg) = kg/(m2*s) /(1000 kg/m3) = m *1000 =mm
# so just multiply by 3600/lvap to get mm   
```

Shape files to include
```{r read_shape, results='hide'}
#domainshp=readShapeSpatial("/Users/laura/Documents/CONUS/Shape_Files/Domain_shp/Domain_short.shp")
domainshp=readOGR("/Users/laura/Documents/CONUS/Shape_Files/Domain_shp/Domain_short.shp")
#regshp=readShapeSpatial("/Users/laura/Documents/CONUS/Shape_Files/Regions_shp/Regions_Project.shp")
regshp=readOGR("/Users/laura/Documents/CONUS/Shape_Files/Regions_shp/Regions_Project.shp")
#statshp=readShapeSpatial("/Users/laura/Documents/CONUS/Shape_Files/States/states_epa_project.shp")
statshp=readOGR("/Users/laura/Documents/CONUS/CONUS-GIS/States/states_epa_project.shp")
greatlakes=readShapeSpatial("/Users/laura/Documents/CONUS/Shape_Files/GreatLakes/great_lakes", proj4string=CRS("+proj=merc +lon_0=0 +lat_ts=0 +x_0=0 +y_0=0 +a=6378137 +b=6378137 +units=m +no_defs"))
#greatlakes=readOGR("/Users/laura/Documents/CONUS/Shape_Files/GreatLakes/great_lakes.shp", p4s=CRS("+proj=merc +lon_0=0 +lat_ts=0 +x_0=0 +y_0=0 +a=6378137 +b=6378137 +units=m +no_defs"))
#Project to UTM
greatlakesUTM=spTransform(greatlakes,CRS("+proj=lcc +lat_1=33 +lat_2=45 +lat_0=39 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs "))

```

Setting up HUCS
```{r HUC_setup}
#Merge US and Canadian HUCs and format into a vector for grouping
#Read in the HUCS
#NOTE- These are the older text files the HUC8 didn't line up perfectly with the USGS gdb file I had and they were cut off at the US border so I remade the HUC8 raster in QGIS in the CONUS_Warming.qgs workspace in this main directory. 
#HUC8=matrix(scan("/Users/laura/Documents/CONUS/Domain_TextFiles/HUC_8.format.txt", skip=1))
#HUC4=matrix(scan("/Users/laura/Documents/CONUS/Domain_TextFiles/HUC_4.format.txt", skip=1))
HUCrast=raster("/Users/laura/Documents/CONUS/CONUS-GIS/HUC8/HUC8_Clip_Raster.tif")
HUCmat=as.matrix(HUCrast)
HUC8=rep(0, nx*ny)
kk=1
for(j in ny:1){
  for(i in 1:nx){
    HUC8[kk]=HUCmat[j,i]
    kk=kk+1
  }	
}
HUC=HUC8 #choosing which HUC to work with

#plottemp=HUC
#maxz=150
#minz=0
#plottemp[which(plottemp>maxz)]=maxz
#plottemp[which(plottemp<minz)]=minz
#rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
#plot(rastertemp1, maxpixels=(nx*ny*10), colNA='lightblue',  col=rev(brewer.pal(name="Spectral", n=11)), legend=T, main="HUC_map", axes=F, zlim=c(minz, maxz))


# Create a combined HUC file with the Candian NHN files
CanNHN=raster("/Users/laura/Documents/CONUS/CONUS-GIS/NHN_INDEX_WORKUNIT_LIMIT_2/NHN_Raster_Temp.tif")
Canmat=as.matrix(CanNHN)
NHN_vec=rep(0, nx*ny)
kk=1
for(j in ny:1){
  for(i in 1:nx){
    NHN_vec[kk]=Canmat[j,i]
    kk=kk+1
  }	
}

HUC_Merge=HUC
#fixlist=which(HUC==(-999) & NHN_vec>0) #for previous HUC matrix where where the NAs were -999
fixlist=which(HUC==(0) & NHN_vec>0) 
HUC_Merge[fixlist]=NHN_vec[fixlist]+3000 #I created a numbering system for the canadian HUCS starting counting at 10 so I'm adding 3000 here so the Canadian numbers don't overlap with the US ones
#rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM,HUC_Merge))
#plot(rastertemp1, maxpixels=(nx*ny*10), colNA='lightblue',  col=rev(brewer.pal(name="Spectral", n=11)), legend=T, main="Baseline PET", axes=F, zlim=c(0,4400))

```

Setting up Regions
```{r}
#Regions
# 1	Pacific Northwest
#	2	Missouri
#	3	Souris-Red Rainy
#	4	Great Lakes
#	5	Upper Mississippi
#	6	Great Basin
#	7	Upper Colorado
#	8	Ohio
#	9	Mid Atlantic
#	10	Lower Colorado
#	11	Arkansas-White-Red
#	12	California
#	13	Rio Grande
#	14	South Atlantic-Gulf
#	15	Tenessee
#	16	Lower Mississippi
#	17	Texas-Gulf


region=matrix(scan("/Users/laura/Documents/CONUS/Final_Domain/Other_Domain_Files/conus_short_usgs_regions.format.txt", skip=1), ncol=1, byrow=T)
regnames=c(	"Pacific Northwest", "Missouri","Souris-Red Rainy", "Great Lakes","Upper Mississippi", "Great Basin","Upper Colorado", "Ohio", "Mid Atlantic", "Lower Colorado", "Arkansas", "California", "Rio Grande", "South Atlantic-Gulf", "Tenessee", "Lower Mississippi","Texas-Gulf")
#list of regions to care about here
#reglist=c(1,2,5,6, 7,8,10,11,13,15,16)
#reglist=c(1,2,5,6, 7,10,8,11, 15) #Withoug RioG and Lower Miss
reglist=c(1,6, 7,10,13, 2,11,5,16,8,15)#ordered moving west to east 
reglist=c(6,10, 7, 1,13, 2,5,11,8,15,16)#ordered by baselin year 1 averge lh
reglist=c(6,10, 7, 13, 1, 2,11,16, 5, 15,8)#ordered by average baseline AI 

#reglist=c(2,6, 7,10,11,13)
regnames[reglist]
plotnames=regnames[reglist]
nreg=length(reglist)
```


## Reading Inputs
Note: Add information about the averaging scripts. 
Read Precipitation
```{r precip_read}
fin="/Users/laura/Documents/CONUS/Transient_Runs/Forcing_Averages/precip.yearly.bin"
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
precip=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#Units of precip are mm/s and the yearly file is average
precipmm=precip*3600
```

Read Porosity:
```{r porosity_read}
porosity=readpfb("/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/CONUS.5layer.pfclm.PumpHS.run4.out.porosity.pfb", verbose=F)
porosity1=as.vector(porosity[,,5])
#rm(porosity)
#image.plot(porosity1)
```

Read Annual LH Flux:
```{r LH_read}
#Read in the LH flux data - this is annual average [w/m2]
lh=array(NA, dim=c(nval, nyear, nrun))
for(r in 1:nrun){
	print(r)
	for(y in 1:nyear){
		print(paste("Year:", y))
	  if(r==2 && y==2){
	    print("skiping 1.5 degree year 2")
	  }else{
		
	  if(r==2){fin=sprintf("%s/Temp%2.1f_Year%d/LH.yearly.bin", dir,runlist[r], ylist[y])
	  }else{
	    fin=sprintf("%s/Temp%d_Year%d/LH.yearly.bin", dir,runlist[r], ylist[y])
	  }
		to.read = file(fin, "rb")
		header=readBin(to.read, integer(), endian = "little", size=4, n=3)
		lh[,y,r]=readBin(to.read, double(), endian = "little", size=8, n=nval)
		close(to.read)
	  }
	} #end for y
} #end for r

#convert from annual average W/m2
lhmm=lh/lvap*3600*24*365 

#Get the simulation totals
lhmm_tot=matrix(NA, nrow=nval, ncol=nrun)
for(r in 1:nrun){ 
	lhmm_tot[,r]=apply(lhmm[,,r], 1, sum )
}

```

Read Annual Soil Moisture:
```{r SM_read}
sm=array(NA, dim=c(nval, nyear, nrun))
for(r in 1:nrun){
	print(r)
	for(y in 1:nyear){
		print(paste("Year:", y))
		if(r==2 && y==2){
	    print("skiping 1.5 degree year 2")
	  }else{
		
	  if(r==2){fin=sprintf("%s/Temp%2.1f_Year%d/SM.yearly.bin", dir,runlist[r], ylist[y])
	  }else{
		  fin=sprintf("%s/Temp%d_Year%d/SM.yearly.bin", dir,runlist[r], ylist[y])
	  }
		print(fin)
		to.read = file(fin, "rb")
		header=readBin(to.read, integer(), endian = "little", size=4, n=3)
		sm[,y,r]=readBin(to.read, double(), endian = "little", size=8, n=nval)
		close(to.read)	
	  }
	} #end for y
} #end for r

```

Read Ending storage:
```{r stor_read}
#Read in the year end storage - month 12 average storage m3
storend=array(NA, dim=c(nval, nyear, nrun))
for(r in 1:nrun){
	print(r)
	for(y in 1:nyear){
		print(paste("Year:", y))
	  
	  if(r==2 && y==2){
	    print("skiping 1.5 degree year 2")
	  }else{
		
	  if(r==2){fin=sprintf("%s/Temp%2.1f_Year%d/storage.monthly.12.bin", dir,runlist[r], ylist[y])
	  }else{
	    fin=sprintf("%s/Temp%d_Year%d/storage.monthly.12.bin", dir,runlist[r], ylist[y])
	  }
		print(fin)
		to.read = file(fin, "rb")
		header=readBin(to.read, integer(), endian = "little", size=4, n=3)
		storend[,y,r]=readBin(to.read, double(), endian = "little", size=8, n=nval)
		close(to.read)	
	  }
	} #end for y
} #end for r

storendmm=storend/(1000^2)*1000 #convert from m^3 to mm
stordif=storendmm[,4,2:nrun]-storendmm[,4,1] #difference in ending storage

```


Read Ending wtd:
```{r wtd_read}
#Read in the ending water table depth - month 12 average WTD in m for year 4
wtdend=array(NA, dim=c(nval, 1, nrun))
for(r in 1:nrun){
	print(r)
  y=4
	  if(r==2){fin=sprintf("%s/Temp%2.1f_Year%d/WTd.monthly.12.bin", dir,runlist[r], ylist[y])
	  }else{
	    fin=sprintf("%s/Temp%d_Year%d/WTd.monthly.12.bin", dir,runlist[r], ylist[y])
	  }
		print(fin)
		to.read = file(fin, "rb")
		header=readBin(to.read, integer(), endian = "little", size=4, n=3)
		wtdend[,1,r]=readBin(to.read, double(), endian = "little", size=8, n=nval)
		close(to.read)	
} #end for r

#setting WTD of ponded areas to zero
wtdend[which(wtdend<0)]=0

```

Calcualte PET:
Note: Update with the provenance of the Daily PET calculations
```{r PET_calc}
#Cacluate Beta and PET based on Beta using annual soil moisture numbers
beta=PET=array(NA, dim=c(nval, nyear, nrun))
for(r in 1:nrun){
  print(r)
  for(y in 1:nyear){
      beta[,y,r]=((sm[,y,r]/porosity1)-0.2)/0.8
      beta[(beta[,y,r]<0),y,r]=0 #getting rid of the negative values where the saturation is less than sres
      PET[,y,r]=lhmm[,y,r]/beta[,y,r]
  }
}

#Read in the PET calcualted from the daily SM and LH 
#Just reading in the ones for the figure here
#Baseline Year 7
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp0_Year7/Baseline.Year7.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PETB7=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#Baseline Year 4
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp0_Year4/Baseline.Year4.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PETB4=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#4 Degree Year 7
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp4_Year7/4Deg_Warming.Year7.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET4deg7=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#4 Degree Year 4
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp4_Year4/4Deg_Warming.Year4.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET4deg4=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#2 Degree Year 7
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp2_Year7/2Deg_Warming.Year7.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET2deg7=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#2 Degree Year 4
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp2_Year4/2Deg_Warming.Year4.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET2deg4=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#1.5 Degree Year 7
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp1.5_Year7/1.5Deg_Warming.Year7.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET15deg7=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#1.5 Degree Year 4
fin="/Users/laura/Documents/CONUS/Warming_Runs/Simulation_Averages/Temp1.5_Year4/1.5Deg_Warming.Year4.PET_mm.yearly.bin"
print(fin)
to.read = file(fin, "rb")
header=readBin(to.read, integer(), endian = "little", size=4, n=3)
PET15deg4=readBin(to.read, double(), endian = "little", size=8, n=nval)
close(to.read)

#Replace the daily calc apprach with annual where you have NAs caused by dialy soil moiture dips
length(which(is.na(PET[,4,3])==T))

repB=which(is.na(PETB7)==T)
PETB7[repB]=PET[repB,4,1]

repB4=which(is.na(PETB4)==T)
PETB4[repB4]=PET[repB4,1,1]

rep15=which(is.na(PET15deg7)==T)
PET15deg7[rep15]=PET[rep15,4,2]

rep154=which(is.na(PET15deg4)==T)
PET15deg4[rep154]=PET[rep154,1,2]

rep2=which(is.na(PET2deg7)==T)
PET2deg7[rep2]=PET[rep2,4,3]

rep24=which(is.na(PET2deg4)==T)
PET2deg4[rep24]=PET[rep24,1,3]

rep4=which(is.na(PET4deg7)==T)
PET4deg7[rep4]=PET[rep4,4,4]

rep44=which(is.na(PET4deg4)==T)
PET4deg4[rep44]=PET[rep44,1,4]

```

Read in the daily total LH and WTD that have been summed across the domain
Note: Update with information about how these these 'yearly.txt' files were calcualted 
```{r daily_totals}

lhD=storageD=matrix(NA, nrow=4*365, ncol=nrun)
for(r in 1:nrun){
	print(r)
	for(y in 4:7){
		print(paste("Year:", y))
		i1=(y-4)*365 +1 
		i2=i1+364
		
		if(r==2 & y ==5){
			print("skipping T1.5 Year5")
		} else{
		
		#lh
		fin=paste(dir, '/Temp', runlist[r], "_Year", y, "/LH.yearly.txt", sep="")
		temp=matrix(scan(fin), ncol=2, byrow=T)
		lhD[i1:i2, r]=temp[,2]
		
		#storage
		fin=paste(dir, '/Temp', runlist[r], "_Year", y, "/storage.yearly.txt", sep="")
		temp=matrix(scan(fin), ncol=2, byrow=T)
		storageD[i1:i2, r]=temp[,2]
		}
		
	}
}

storageD[952,3]=storageD[951,3] # Fixing one corrupted file
stordifD=storageD-storageD[1,1] #Difference from the initial baseline storage

lhD_m3=lhD*3600/lvap*24*1000^2/1000

```


## Spaital aggregations
Aggregate by HUC
```{r HUC_agg}
#Aggregate by HUC
HUC_list=sort(unique(HUC_Merge))
nhuc=length(HUC_list)

#HUC Summary matrices
precipmm_HUC=area_HUC=rep(0, nhuc) #Summary matrix with a row for every HUC
lhmm_HUC=storendmm_HUC=PET_HUC=array(0, c(nhuc, nyear, nrun))
stordif_HUC=matrix(0, nrow=nhuc, ncol=(nrun-1))

#HUG grid matrices
lhmm_Hgrid=storendmm_Hgrid=PET_Hgrid=array(0, c(nval, nyear, nrun)) #matrix assigning the HUC sum value to every grid cell
stordif_Hgrid=array(0, c(nval, nrun-1) )#matrix assigning the HUC sum value to every grid cell
precipmm_Hgrid=area_Hgrid=rep(0, nval)
                     
#summing all of the matrix values
for(h in 1:nhuc){
  #print(h)
  hnum=HUC_list[h]
  ilist=which(HUC_Merge==hnum)
  
  #Recording the HUC sums in the HUC matrix
  area_HUC[h]=length(ilist)
  
  if(length(ilist)>1){
    #Precipitation
    precipmm_HUC[h]=sum(precipmm[ilist])
    precipmm_Hgrid[ilist]= precipmm_HUC[h]
    
    #lhmm and storend sums
    for(r in 1:nrun){
      for(y in 1:nyear){
        lhmm_HUC[h,y,r]=sum(lhmm[ilist, y, r])
        lhmm_Hgrid[ilist,y,r]=lhmm_HUC[h,y,r]
        
        PET_HUC[h,y,r]=sum(PET[ilist, y, r])
        PET_Hgrid[ilist,y,r]=PET_HUC[h,y,r]
          
        storendmm_HUC[h,y,r]=sum(storendmm[ilist, y, r])
        storendmm_Hgrid[ilist,y,r]=storendmm_HUC[h,y,r]
      }
    }
    
    #stordif sum
    for(r in 1:(nrun-1)){
      stordif_HUC[h, r]=sum(stordif[ilist, r])
      stordif_Hgrid[ilist, r]=stordif_HUC[h, r]
    }
  } #end if
  
}



#zeroing out the values for the -999 HUC
stordif_HUC[1,]=NA
storendmm_HUC[1,,]=NA
lhmm_HUC[1,,]=NA
PET_HUC[1,,]=NA
precipmm_HUC[1]=NA

ilist=which(HUC_Merge==HUC_list[1])
stordif_Hgrid[ilist,]=NA
storendmm_Hgrid[ilist,,]=NA
lhmm_Hgrid[ilist,,]=NA
PET_Hgrid[ilist,,]=NA
precipmm_Hgrid[ilist]=NA

#Get the LH simulation totals over all 4 years
lhmm_Hgridtot=matrix(NA, nrow=nval, ncol=nrun)
for(r in 1:nrun){ 
	lhmm_Hgridtot[,r]=apply(lhmm_Hgrid[,,r], 1, sum )
}
```

Aggregate by Region
```{r Reg_agg}
#setup matrics
lhreg=array(0, dim=c(nreg,4,4))
lhregdif=array(0, dim=c(nreg,4,3))
storendregmm=array(0, dim=c(nreg,4,4))
storegdifmm=array(0, dim=c(nreg,4,3))
AIBreg=rep(0,nreg)
rarea=rep(0,nreg)

#loop over regions caculating totals
for(r in 1:nreg){
  #identify the cells in the region
	rtemp=reglist[r]
	rindex=which(region==rtemp)
	rarea[r]=length(rindex)
	
	#Calculate the baseline aridity
	temp=PETB7/precipmm
	temp[temp>7]=7
	temp[temp<0]=0
	AIBreg[r]=mean(temp[rindex], na.rm=T, is.finite=T)
	
	#average over the regions cells
	for(y in 1:nyear){
	  for(ri in 1:nrun){
	    storendregmm[r,y, ri]=mean(storendmm[rindex,y,ri]) #average ending storage
	    lhreg[r,y, ri]=mean(lhmm[rindex,y, ri]) #average lh [mm]
	    if(ri>1){
	      	lhregdif[r,,(ri-1)] = lhreg[r,,ri] - lhreg[r,,1]
	      	storegdifmm[r,,(ri-1)] = storendregmm[r,,ri] - storendregmm[r,,1]
	    }
	  }
	}
  

	print(paste(rtemp , ":",length(rindex)))
}
```


## Paper Figures
## Figure 1: Aridity Index
```{r AI_Fig, fig.width=8.1, fig.height=8.9, warning=FALSE}
fout=paste(plotdir, "Annual_AIClassifications_FullColor_4panel_PETrev.pdf", sep="")
pdf(fout, width=12, height=6.7)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))

maxz=7
minz=0

#color list if you want to just break at o.8 and 1.2
breaklist=c(0, 0.8, 1, 1.2,7)
collist=rev(c('#e08214', '#fdb863', '#b2abd2', '#8073ac'))

#complete color list
#breaklist=c(0, 0.2, 0.4, 0.6, 0.8, 1,1.5,2,3,5,7)
#collist=rev(brewer.pal(name="Spectral", n=10))

#Baseline
#AIB=(annB[,3]/betaB)/precipmm
AIB=PETB7/precipmm
plottemp=AIB
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10), col=collist,  main="a) Baseline AI (PET/P)", axes=F, zlim=c(minz, maxz), breaks=breaklist, xlab="", ylab="")
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
#plot(regshp, add=T, border='darkgrey', lwd=1)
plot(statshp, add=T, border='black', lwd=0.5)
box()
image.plot(legend.only=T, breaks=1:5, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2) #, legend.args=list( text="AI",cex=1, side=4, line=1)) #use if you do the 0.8, 1.2 color pallette
#image.plot(legend.only=T, breaks=1:11, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2) #, legend.args=list( text="AI",cex=1, side=4, line=1))

#1.5 degree - difference
#AI15=(ann15[,3]/beta15)/precipmm
AI15=PET15deg7/precipmm
#plottemp=AI15
#plottemp[which(plottemp>maxz)]=maxz
#plottemp[which(plottemp<minz)]=minz
#rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
#image(rastertemp1, maxpixels=(nx*ny*10), breaks=breaklist,col=collist,   main="1.5 Degree Warming AI", axes=F, zlim=c(minz, maxz), xlab="", ylab="")
#box()
#image.plot(legend.only=T, breaks=1:5, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2) #, legend.args=list( text="AI",cex=1.2, side=4, line=6))


#Categorical Differenceces
collist=c("white", "green", "blue", "red")
#collist=c("white", "#542788", "#a6dba0", "#b35806")

#1.5 degree
#find locations that swapped categories
swap15=rep(0,nval)
breaklist=c(0, 0.8, 1, 1.2,7)
find1=which(AIB<0.8 & AI15>0.8) #swaping from strongly to wekaly energy limited
find2=which(AIB<1 & AI15>1) #swaping from energy to water limited
find3=which(AIB>1 & AIB <1.2 & AI15>1.2) #swaping from slightly to significantly water limited
swap15[find1]=1
swap15[find2]=2
swap15[find3]=3

plottemp=swap15
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10),   axes=F, col=collist, breaks=c(-0.5, 0.1, 1.1, 2.2, 3.2), main="b) AI Classificaiton Changes 1.5 Degree", xlab="", ylab="", zlim=c(0,3))
plot(greatlakesUTM, add=T, col='lightgrey', border='black', lwd=0.5)
#plot(regshp, add=T, border='darkgrey', lwd=1)
plot(statshp, add=T, border='black', lwd=0.5)
box()
#image.plot(legend.only=T, breaks=1:length(breaklist), zlim=c(0,3), col=collist, legend.width=2) #, legend.args=list( text="AI",cex=1.2, side=4, line=6))

#2 degree
AI2=PET2deg7/precipmm
swap2=rep(0,nval)
find1=which(AIB<0.8 & AI2>0.8) #swaping from strongly to wekaly energy limited
find2=which(AIB<1 & AI2>1) #swaping from energy to water limited
find3=which(AIB>1 & AIB <1.2 & AI2>1.2) #swaping from slightly to significantly water limited
swap2[find1]=1
swap2[find2]=2
swap2[find3]=3

plottemp=swap2
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10),   axes=F, col=collist, breaks=c(-0.5, 0.1, 1.1, 2.2, 3.2), main="c) AI Classificaiton Changes 2 Degree", xlab="", ylab="", zlim=c(0,3))
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
#plot(regshp, add=T, border='darkgrey', lwd=1)
plot(statshp, add=T, border='black', lwd=0.5)
box()
#image.plot(legend.only=T, breaks=1:length(breaklist), zlim=c(0,3), col=collist, legend.width=2) #, legend.args=list( text="AI",cex=1.2, side=4, line=6))

#4 degree
AI4=PET4deg7/precipmm
swap4=rep(0,nval)
find1=which(AIB<0.8 & AI4>0.8) #swaping from strongly to wekaly energy limited
find2=which(AIB<1 & AI4>1) #swaping from energy to water limited
find3=which(AIB>1 & AIB <1.2 & AI4>1.2) #swaping from slightly to significantly water limited
swap4[find1]=1
swap4[find2]=2
swap4[find3]=3

plottemp=swap4
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10),   axes=F, col=collist, breaks=c(-0.5, 0.1, 1.1, 2.2, 3.2), main="d) AI Classificaiton Changes 4 Degree", xlab="", ylab="", zlim=c(0,3))
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
#plot(regshp, add=T, border='darkgrey', lwd=1)
plot(statshp, add=T, border='black', lwd=0.5)
box()
image.plot(legend.only=T, breaks=1:length(breaklist), zlim=c(0,3), col=collist, legend.width=2, axis.args=list(at=c(1.5, 2.5, 3.5, 4.5), labels=c("NC", "SEL to WEL", "WEL to WWL", "WWL to SWL"), cex.axis=0.6)) #, legend.args=list( text="AI",cex=1.2, side=4, line=6))

dev.off()


```

## Figure 2: ET Changes
Part 1: Maps of ET and ET changes
```{r ET_Maps, fig.width=12, fig.height=6.6}
fout=paste(plotdir, "Annual_ET_4panel.pdf", sep="")
#pdf(fout, width=5.9, height=8.9)
#par(mfrow=c(3,1), mar=c(1,2,3,3))
pdf(fout, width=12, height=6.6)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))
maxz=1000
minz=0

#Baseline
#plottemp=annB[,3]
plottemp=lhmm[,4,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="Spectral", n=10)), colNA='lightblue',  legend=T, main="Baseline ET (mm)", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)

#1.5 Difference
#plottemp=ann15[,3]-annB[,3]
plottemp=lhmm[,4,2]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="1.5 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(statshp, add=T, border='black', lwd=0.5)
#plot(regshp, add=T, border='black')


#2 Difference
#plottemp=ann2[,3]-annB[,3]
plottemp=lhmm[,4,3]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="2 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

#4 Difference
#plottemp=ann4[,3]-annB[,3]
plottemp=lhmm[,4,4]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="4 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

dev.off()


```

Part 2: Regional trends
```{r ET_Lines, fig.width=6, fig.height=2}
display.brewer.pal(name='Spectral',n=11)
collist=brewer.pal(name='Spectral',n=11)
collist[6:10]=c('#c7e9b4','#7fcdbb','#41b6c4','#2c7fb8','#253494')
collist[6]='#a1d99b'
barplot(height=rep(1,11), width=rep(1,11), space=0,border=NA, col= collist, beside=F)

ylab="Avg. ET change per degree warming [mm]"

fout=paste(plotdir, "Regional_Differences_PerDT.pdf", sep="")
pdf(fout, width=4, height=6)

for(r in 1:nreg){
	plotdata=c(lhregdif[r,4,1]/1.5, lhregdif[r,4,2]/2, lhregdif[r,4,3]/4)
	if(r==1){
		plot(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], xlim=c(1,4.5), ylim=c(0,80), xlab="Warming [deg C]",ylab=ylab, lwd=2)
	}
	
	lines(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], lwd=2)
	#legend("topright", legend=plotnames, col=collist, pch=rep(16,nreg), bty="n")
}
```

Part 3: Color legend for the regions
```{r region_map, fig.width=7, fig.height=5 }
fout=paste(plotdir, "BasinMap.pdf", sep="")
pdf(fout, width=7.6, height=5)
reg_col=rep(NA, nval)
for(r in 1:nreg){
  rtemp=reglist[r]
	rindex=which(region==rtemp)
	reg_col[rindex]=r
}
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, reg_col))
plot(rastertemp1, maxpixels=(nx*ny*10), col=collist, breaks=(1:(length(collist)+1)-0.1),  colNA='white',  legend=F,  axes=F)
plot(statshp, add=T, border='black', lwd=0.5)
plot(greatlakesUTM, add=T, col='white', border='black', lwd=0.5)
plot(domainshp, add=T, border='black', lwd=2)
dev.off()
```

## Figure 3: Storage differences
Supporting volume clacs for figure 3 disucssion 
```{r store_stats}
#Calcualting the totals for the paper
#total storage
totaldif=apply(stordif, 2, sum)/1000  #/1000 to convert from mm to MCM

#East west storage
eastmask=rep(0, nval)
eastmask[which(xUTM>=mean(xUTM))]=1
eastdif=apply(stordif[which(eastmask==1),], 2, sum)/1000 #storage losses in the east
westdif=apply(stordif[which(eastmask==0),], 2, sum)/1000 #storage losses in the west
round(eastdif/totaldif,2)

#latent heat year 4 differences 
lhdif1.5 = lhmm[,4,2]-lhmm[,4,1]
lhdif2 = lhmm[,4,3]-lhmm[,4,1]
lhdif4 = lhmm[,4,4]-lhmm[,4,1]

round(sum(lhdif1.5[which(eastmask==1)])/sum(lhdif1.5),2)
round(sum(lhdif2[which(eastmask==1)])/sum(lhdif2),2)
round(sum(lhdif4[which(eastmask==1)])/sum(lhdif4),2)

```

Part 1: Ending storage differences
```{r storend_maps, fig.width=8.1, fig.height=8.9, warning=FALSE}
fout=paste(plotdir, "Ending_Storage_Diff.pdf", sep="")
pdf(fout, width=12, height=6.6)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))


<<<<<<< HEAD
## Figure 2: WTD
```{r ET_Maps, fig.width=12, fig.height=6.6}
fout=paste(plotdir, "WTD_Ending_4panel.pdf", sep="")
#pdf(fout, width=5.9, height=8.9)
#par(mfrow=c(3,1), mar=c(1,2,3,3))
pdf(fout, width=12, height=6.6)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))
maxz=1.5
minz=-1

#Baseline
#plottemp=annB[,3]
plottemp=wtdend[,1,1]
plottemp[which(plottemp==0)]=NA
plottemp=log(plottemp, 10)
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="GnBu", n=9)), colNA='black',  legend=T, main="Baseline log(WTD[m])", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)

#1.5 Difference
#plottemp=ann15[,3]-annB[,3]
plottemp=wtdend[,1,2]-wtdend[,1,1]
maxz=2
minz=0
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="OrRd", n=9)), colNA='black',  legend=T, main="1.5 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(statshp, add=T, border='black', lwd=0.5)
#plot(regshp, add=T, border='black')


#2 Difference
#plottemp=ann2[,3]-annB[,3]
plottemp=wtdend[,1,3]-wtdend[,1,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="OrRd", n=9)), colNA='black',  legend=T, main="2 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

#4 Difference
#plottemp=ann4[,3]-annB[,3]
plottemp=wtdend[,1,4]-wtdend[,1,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="OrRd", n=9)), colNA='black',  legend=T, main="4 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

dev.off()


```

## Figure 3: ET Changes
Part 1: Maps of ET and ET changes
```{r ET_Maps, fig.width=12, fig.height=6.6}
fout=paste(plotdir, "Annual_ET_4panel.pdf", sep="")
#pdf(fout, width=5.9, height=8.9)
#par(mfrow=c(3,1), mar=c(1,2,3,3))
pdf(fout, width=12, height=6.6)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))
maxz=1000
minz=0

#Baseline
#plottemp=annB[,3]
plottemp=lhmm[,4,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="Spectral", n=10)), colNA='lightblue',  legend=T, main="Baseline ET (mm)", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)

#1.5 Difference
#plottemp=ann15[,3]-annB[,3]
plottemp=lhmm[,4,2]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="1.5 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(statshp, add=T, border='black', lwd=0.5)
#plot(regshp, add=T, border='black')


#2 Difference
#plottemp=ann2[,3]-annB[,3]
plottemp=lhmm[,4,3]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="2 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

#4 Difference
#plottemp=ann4[,3]-annB[,3]
plottemp=lhmm[,4,4]-lhmm[,4,1]
maxz=200
minz=-200
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=(brewer.pal(name="PuOr", n=10)), colNA='black',  legend=T, main="4 Warming - Baseline", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(regshp, add=T, border='black')
plot(statshp, add=T, border='black', lwd=0.5)
#abline(v=0)

dev.off()


```

Part 2: Regional trends
```{r ET_Lines, fig.width=6, fig.height=2}
display.brewer.pal(name='Spectral',n=11)
collist=brewer.pal(name='Spectral',n=11)
collist[6:10]=c('#c7e9b4','#7fcdbb','#41b6c4','#2c7fb8','#253494')
collist[6]='#a1d99b'
barplot(height=rep(1,11), width=rep(1,11), space=0,border=NA, col= collist, beside=F)

ylab="Avg. ET change per degree warming [mm]"

fout=paste(plotdir, "Regional_Differences_PerDT.pdf", sep="")
pdf(fout, width=4, height=6)

for(r in 1:nreg){
	plotdata=c(lhregdif[r,4,1]/1.5, lhregdif[r,4,2]/2, lhregdif[r,4,3]/4)
	if(r==1){
		plot(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], xlim=c(1,4.5), ylim=c(0,80), xlab="Warming [deg C]",ylab=ylab, lwd=2)
	}
	
	lines(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], lwd=2)
	#legend("topright", legend=plotnames, col=collist, pch=rep(16,nreg), bty="n")
}
```

Part 3: Color legend for the regions
```{r region_map, fig.width=7, fig.height=5 }
fout=paste(plotdir, "BasinMap.pdf", sep="")
pdf(fout, width=7.6, height=5)
reg_col=rep(NA, nval)
for(r in 1:nreg){
  rtemp=reglist[r]
	rindex=which(region==rtemp)
	reg_col[rindex]=r
}
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, reg_col))
plot(rastertemp1, maxpixels=(nx*ny*10), col=collist, breaks=(1:(length(collist)+1)-0.1),  colNA='white',  legend=F,  axes=F)
plot(statshp, add=T, border='black', lwd=0.5)
plot(greatlakesUTM, add=T, col='white', border='black', lwd=0.5)
plot(domainshp, add=T, border='black', lwd=2)
dev.off()
```

## Figure 4: Storage differences
Supporting volume clacs for figure 3 disucssion 
```{r store_stats}
#Calcualting the totals for the paper
#total storage
totaldif=apply(stordif, 2, sum)/1000  #/1000 to convert from mm to MCM

#East west storage
eastmask=rep(0, nval)
eastmask[which(xUTM>=mean(xUTM))]=1
eastdif=apply(stordif[which(eastmask==1),], 2, sum)/1000 #storage losses in the east
westdif=apply(stordif[which(eastmask==0),], 2, sum)/1000 #storage losses in the west
round(eastdif/totaldif,2)

#latent heat year 4 differences 
lhdif1.5 = lhmm[,4,2]-lhmm[,4,1]
lhdif2 = lhmm[,4,3]-lhmm[,4,1]
lhdif4 = lhmm[,4,4]-lhmm[,4,1]

round(sum(lhdif1.5[which(eastmask==1)])/sum(lhdif1.5),2)
round(sum(lhdif2[which(eastmask==1)])/sum(lhdif2),2)
round(sum(lhdif4[which(eastmask==1)])/sum(lhdif4),2)

```

Part 1: Ending storage differences
```{r storend_maps, fig.width=8.1, fig.height=8.9, warning=FALSE}
fout=paste(plotdir, "Ending_Storage_Diff.pdf", sep="")
pdf(fout, width=12, height=6.6)
par(oma=c( 0,0,0,4))
par(mfrow=c(2,2), mar=c(1,2,3,4))


=======
>>>>>>> 7c9ad5f0d3786804d59b3e9d04ccc0169e28d663

maxz=0
minz=-100

#1.5 degree 
plottemp=stordif[,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="YlOrRd", n=5)), colNA='lightblue',  legend=T, main="1.5 Degree Ending Storage dif [mm]", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
plot(statshp, add=T, border='black', lwd=0.5)
abline(v=mean(xUTM), col="blue", lwd=1, lty=3)

#2 degree 
plottemp=stordif[,2]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="YlOrRd", n=5)), colNA='lightblue',  legend=T, main="2 Degree Ending Storage dif [mm]", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
plot(statshp, add=T, border='black', lwd=0.5)
abline(v=mean(xUTM), col="blue", lwd=1, lty=3)

#4 degree 
plottemp=stordif[,3]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=rev(brewer.pal(name="YlOrRd", n=5)), colNA='lightblue',  legend=T, main="4 Degree Ending Storage dif [mm]", axes=F, zlim=c(minz, maxz))
plot(greatlakesUTM, add=T, col='lightgrey', border='black')
plot(statshp, add=T, border='black', lwd=0.5)
abline(v=mean(xUTM), col="blue", lwd=1, lty=3)

dev.off()
<<<<<<< HEAD

```

Part 2: Daily timeseries of domain total storage
```{r daily_storage, fig.width=7, fig.height=4}
fout=paste(plotdir, "Daily_StorageTotal_Lines.pdf", sep="")
pdf(fout, width=8, height=6)

nday=nrow(stordifD)
plot(1:nday, stordifD[,1]/10^6, type='l', lwd=2, col='black', ylim=c(min(stordifD[1:500,]/10^6, na.rm=T), max(stordifD/10^6,na.rm=T)),xlim=c(1,nday), ylab='Storage change from Baseline Day1 [MCM]' ,xlab="", axes=F)
abline(v=seq(1:3)*365, lty=3)
axis(2)
#axis(1, at=seq(1, nday, 30), labels=F)
box()
lines(1:nday, stordifD[,2]/10^6, lwd=2, col='orange')
lines(1:nday, stordifD[,3]/10^6, lwd=2, col='red')
lines(1:nday, stordifD[,4]/10^6, lwd=2, col='darkred')

dev.off()
=======
>>>>>>> 7c9ad5f0d3786804d59b3e9d04ccc0169e28d663

#difference lines
#nday=nrow(stordifD)
#plot(1:nday, (stordifD[,2]-stordifD[,1]), type='l', lwd=2, col='orange', ylim=c(-3.5e11,0), ylab='Storage Difference (Warming-Baseline)[m3]')
#lines(1:nday, (stordifD[,3]-stordifD[,1]), lwd=2, col='red')
#lines(1:nday, (stordifD[,4]-stordifD[,1]), lwd=2, col='darkred')
#abline(v=seq(1:4)*365)
#bline(h=0)

```

Part 3: Regional trends
```{r ET_Lines, fig.width=6, fig.height=2}
display.brewer.pal(name='Spectral',n=11)
collist=brewer.pal(name='Spectral',n=11)
collist[6:10]=c('#c7e9b4','#7fcdbb','#41b6c4','#2c7fb8','#253494')
collist[6]='#a1d99b'
barplot(height=rep(1,11), width=rep(1,11), space=0,border=NA, col= collist, beside=F)

ylab="Avg.storage change per degree warming [mm]"

fout=paste(plotdir, "Storage_Regional_Differences_PerDT.pdf", sep="")
pdf(fout, width=4, height=6)

for(r in 1:nreg){
	plotdata=c(storegdifmm[r,4,1]/1.5, storegdifmm[r,4,2]/2, storegdifmm[r,4,3]/4)
	if(r==1){
		plot(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], ylim=c(-5,-30), xlim=c(1,4.5), xlab="Warming [deg C]",ylab=ylab, lwd=2)
	}
	
	lines(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], lwd=2)
	#legend("topright", legend=plotnames, col=collist, pch=rep(16,nreg), bty="n")
}
```

<<<<<<< HEAD
## Figure 5: ET sensitivity scatter plots
=======
Part 2: Daily timeseries of domain total storage
```{r daily_storage, fig.width=7, fig.height=4}
fout=paste(plotdir, "Daily_StorageTotal_Lines.pdf", sep="")
pdf(fout, width=8, height=6)

nday=nrow(stordifD)
plot(1:nday, stordifD[,1]/10^6, type='l', lwd=2, col='black', ylim=c(min(stordifD[1:500,]/10^6, na.rm=T), max(stordifD/10^6,na.rm=T)),xlim=c(1,nday), ylab='Storage change from Baseline Day1 [MCM]' ,xlab="", axes=F)
abline(v=seq(1:3)*365, lty=3)
axis(2)
#axis(1, at=seq(1, nday, 30), labels=F)
box()
lines(1:nday, stordifD[,2]/10^6, lwd=2, col='orange')
lines(1:nday, stordifD[,3]/10^6, lwd=2, col='red')
lines(1:nday, stordifD[,4]/10^6, lwd=2, col='darkred')

dev.off()

#difference lines
#nday=nrow(stordifD)
#plot(1:nday, (stordifD[,2]-stordifD[,1]), type='l', lwd=2, col='orange', ylim=c(-3.5e11,0), ylab='Storage Difference (Warming-Baseline)[m3]')
#lines(1:nday, (stordifD[,3]-stordifD[,1]), lwd=2, col='red')
#lines(1:nday, (stordifD[,4]-stordifD[,1]), lwd=2, col='darkred')
#abline(v=seq(1:4)*365)
#bline(h=0)

```

Part 3: Regional trends
```{r ET_Lines, fig.width=6, fig.height=2}
display.brewer.pal(name='Spectral',n=11)
collist=brewer.pal(name='Spectral',n=11)
collist[6:10]=c('#c7e9b4','#7fcdbb','#41b6c4','#2c7fb8','#253494')
collist[6]='#a1d99b'
barplot(height=rep(1,11), width=rep(1,11), space=0,border=NA, col= collist, beside=F)

ylab="Avg.storage change per degree warming [mm]"

fout=paste(plotdir, "Storage_Regional_Differences_PerDT.pdf", sep="")
pdf(fout, width=4, height=6)

for(r in 1:nreg){
	plotdata=c(storegdifmm[r,4,1]/1.5, storegdifmm[r,4,2]/2, storegdifmm[r,4,3]/4)
	if(r==1){
		plot(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], ylim=c(-5,-30), xlim=c(1,4.5), xlab="Warming [deg C]",ylab=ylab, lwd=2)
	}
	
	lines(c(1.5, 2, 4), plotdata, type='b', pch=16, col=collist[r], lwd=2)
	#legend("topright", legend=plotnames, col=collist, pch=rep(16,nreg), bty="n")
}
```

## Figure 4: ET sensitivity scatter plots
>>>>>>> 7c9ad5f0d3786804d59b3e9d04ccc0169e28d663
```{r dET_dPET_Scatter}
fout=paste(plotdir, "dET_dPET_Scatter.pdf", sep="")
pdf(fout, width=6, height=3)

par(mfrow=c(1,3))

#1.5 Degree Plot: 
  r=2
  #year 4
  y=4
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='blue',  main="1.5 Degree")
  #legend('topright', legend=c("Year 1", "Year 4"), pch=rep(16,2),  col=c("black", "blue"), bty='n', cex=1.2)
  
  # year 1
  y=1
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='green')
  
#2 degree plot
  r=3
  y=4
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  
  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='blue',  main="2 Degree")
  #legend('topright', legend=c("Year 1", "Year 4"), pch=rep(16,2),  col=c("black", "blue"), bty='n', cex=1.2)
  
  # year1
  y=1
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='green')

  #4 degree plot
  r=4
  y=4
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  
  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='blue',  main="4 Degree")
  #legend('topright', legend=c("Year 1", "Year 4"), pch=rep(16,2),  col=c("black", "blue"), bty='n', cex=1.2)
  
  # year1
  y=1
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='green')

dev.off()
  
```

### --------------------------------------------------------------------------------------------------------------
## Additional Plotting
Total LH Flux plot
```{r LHtot_plot, fig.width=8.1, fig.height=8.9, warning=FALSE}
#fout=paste(plotdir, "LH_Total_Diff.pdf", sep="")
#pdf(fout, width=8.1, height=8.9)
par(mfrow=c(2,1), mar=c(1,2,3,3))

maxz=1000
minz=0

#2 degree 
plottemp=lhmm_tot[,2]-lhmm_tot[,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightblue',  legend=T, main="2 Degree Total LH Difference [mm]", axes=F, zlim=c(minz, maxz))

#4 degree 
plottemp=lhmm_tot[,3]-lhmm_tot[,1]
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightblue',  legend=T, main="2 Degree Total LH Difference [mm]", axes=F, zlim=c(minz, maxz))

#dev.off()
```

Storage change divided by LH flux increase plot
```{r StorLH_plot, fig.width=8.1, fig.height=8.9, warning=FALSE}
#fout=paste(plotdir, "Storage_LH_Ratio.pdf", sep="")
#pdf(fout, width=8.1, height=8.9)
par(mfrow=c(2,1), mar=c(1,2,3,3))

maxz=0.5
minz=0

#2 degree 
plottemp=(-stordif[,1])/(lhmm_tot[,2]-lhmm_tot[,1]) #year for ending storage dif/ total LH dif
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightblue',  legend=T, main="2 Degree stordif/LH dif [mm]", axes=F, zlim=c(minz, maxz))

#4 degree 
plottemp=(-stordif[,2])/(lhmm_tot[,3]-lhmm_tot[,1])
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightblue',  legend=T, main="2 Degree stordif/LH dif[mm]", axes=F, zlim=c(minz, maxz))

#dev.off()
```

Aridity index
```{r AI plot, fig.width=8.1, fig.height=8.9, warning=FLASE }
par(oma=c( 0,0,0,4))
par(mfrow=c(2,1), mar=c(1,2,3,4))
maxz=7
minz=0
breaklist=c(0, 0.2, 0.4, 0.6, 0.8, 1,1.5,2,3,5,7)
collist=rev(brewer.pal(name="Spectral", n=10))


#Baseline simulation from yearly calcs
AIB=PET[,4,3]/precipmm #Baseline year7 PET/precip
plottemp=AIB
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10), col=collist,  main="Baseline AI (PET/P)", axes=F, zlim=c(minz, maxz), breaks=breaklist, xlab="", ylab="")
#plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(statshp, add=T, border='black')
box()
image.plot(legend.only=T, breaks=1:11, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2) #, legend.args=list( text="AI",cex=1, side=4, line=1))

#Baseline simulation from daily calcs
AIB=PETB7/precipmm #Baseline year7 PET/precip
plottemp=AIB
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
image(rastertemp1, maxpixels=(nx*ny*10), col=collist,  main="Baseline AI (PET/P)", axes=F, zlim=c(minz, maxz), breaks=breaklist, xlab="", ylab="")
#plot(greatlakesUTM, add=T, col='lightgrey', border='lightgrey')
#plot(statshp, add=T, border='black')
box()
image.plot(legend.only=T, breaks=1:11, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2) #, legend.args=list( text="AI",cex=1, side=4, line=1))

```

Delta ET/Delta PET
```{r}
  #4 degree - year 1  
  y=1
  r=3
  dPET=PET[,y,r]-PET[,y,1]
  dET=lhmm[,y,r]-lhmm[,y,1]
  deltaratio=dET/dPET
  maxz=1
  minz=0
  
  par(mfrow=c(2,1), mar=c(1,2,3,3))

 
  plottemp=deltaratio 
  plottemp[which(plottemp>maxz)]=maxz
  plottemp[which(plottemp<minz)]=minz
  rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
  plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=9), colNA='lightblue',  legend=T, main="2 Degree stordif/LH dif [mm]", axes=F, zlim=c(minz, maxz))
  
  #4 degree - year 4 
  y=4
  r=3
  dPET=PET[,y,r]-PET[,y,1]
  dET=lhmm[,y,r]-lhmm[,y,1]
  deltaratio=dET/dPET
  maxz=1
  minz=0
  plottemp=deltaratio 
  plottemp[which(plottemp>maxz)]=maxz
  plottemp[which(plottemp<minz)]=minz
  rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
  plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=9), colNA='lightblue',  legend=T, main="2 Degree stordif/LH dif [mm]", axes=F, zlim=c(minz, maxz))
  
```
 
Scatter plot of dET/dPET compared to aridity and change in storage
```{r, fig.width=4, fig.height=4}
  #Coloring by the equivalent depth of storage change
  #colvar=(storendmm_HUC[,y,r]-storendmm_HUC[,y,1])/area_HUC #Difference in ending storage averaged over the HUC area
  #colvar=AI
  #rbPal = brewer.pal(name="Spectral", n=10)
  #rbPal = brewer.pal(name="YlOrRd", n=9)
  #breakpoints=seq(0,7,by=0.7)
  #breakpoints=seq(-90,0,by=10)
  #nbreak=length(breakpoints)
  #bins=as.numeric(cut(colvar, breaks=breakpoints, right=T, include.lowest=T))
  #collist = rbPal[bins]

par(mfrow=c(2,2))
#####
#First plot compare across warming scenarios for one year
  y=1
  
  #2 degree run
  r=2
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  

  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='orange', main=c("Year 1 - ET Sensitivity vs Aridity"))
  legend('topright', legend=c("2 degree", "4 degree"), pch=rep(16,2),  col=c("orange", "red"), bty='n', cex=1.2)
  
  # 4 degree run
  r=3
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='red')
#################
  
#Second plot compare across warming scenarios for one year
  y=4
  
  #2 degree run
  r=2
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  

  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='orange', main=c("Year 4 - ET Sensitivity vs Aridity"))
  legend('topright', legend=c("2 degree", "4 degree"), pch=rep(16,2),  col=c("orange", "red"), bty='n', cex=1.2)
  
  # 4 degree run
  r=3
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='red')
#################
  
#Third plot compare from year 1 to year 4 2 degree case
  r=2
  
  #year 4
  y=4
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  

  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='blue',  main=c("2 Degree - ET Sensitivity vs Aridity"))
  legend('topright', legend=c("Year 1", "Year 4"), pch=rep(16,2),  col=c("black", "blue"), bty='n', cex=1.2)
  
  # year 1
  y=1
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='black')
#################
  
#Fourth plot compare from year 1 to year 4 4 degree case
    r=3
  
  #2 degree run
  y=4
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  

  plot(AI, deltaratio, type='p', xlim=c(0,7), ylim=c(0,1), xlab="Aridity Index", ylab="dET/dPET", pch=16, cex=0.6, col='blue',  main=c("4 Degree - ET Sensitivity vs Aridity"))
  legend('topright', legend=c("Year 1", "Year 4"), pch=rep(16,2),  col=c("black", "blue"), bty='n', cex=1.2)
  
  # 4 degree run
  y=1
  dPET=PET_HUC[,y,r]-PET_HUC[,y,1]
  dET=lhmm_HUC[,y,r]-lhmm_HUC[,y,1]
  deltaratio=dET/dPET #Change in ET/ Change in PET
  AI=PET_HUC[,y,r]/precipmm_HUC #Baseline run aridity index
  points(AI, deltaratio,  pch=16, cex=0.5, col='black')



  
```


## HUC Plotting
Aridity index by HUC
```{r AI_HUC, warning=FALSE}

  AI_Hgrid=PET_Hgrid[,4,1]/precipmm_Hgrid

  #AI_HUC=PET_HUC[,4,3]/lhmm_HUC[,4,3]
  #AI_Hgrid=PET[,4,1]/precipmm
  maxz=7
  minz=0

  #color list if you want to just break at o.8 and 1.2
  #breaklist=c(0, 0.8, 1, 1.2,7)
  #collist=rev(c('#e08214', '#fdb863', '#b2abd2', '#8073ac'))
  
  #collist=c('#eff3ff', '#abdda4', '#fdae61', "#fee5d9" )
  #collist=rev(c('#e66101', '#fdb863', '#b2abd2', '#5e3c99'))
  #collist=rev(c('#fdb863', '#fee0b6', '#d8daeb', '#b2abd2'))
  #collist=(rev(brewer.pal(name="Spectral", n=4)))

  #complete color list
  breaklist=c(0, 0.2, 0.4, 0.6, 0.8, 1,1.5,2,3,5,7)
  collist=rev(brewer.pal(name="Spectral", n=10))

  #Baseline
  plottemp=AI_Hgrid
  plottemp[which(plottemp>maxz)]=maxz
  plottemp[which(plottemp<minz)]=minz
  rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
    par(mar=c(1,2,3,5))
  image(rastertemp1, maxpixels=(nx*ny*10), col=collist,  main="a) Baseline AI (PET/P)", axes=F, zlim=c(minz, maxz), breaks=breaklist, xlab="", ylab="")
#plot(greatlakesUTM, add=T, col='lightgrey', border='black')
#plot(statshp, add=T, border='black')
box()
image.plot(legend.only=T, breaks=1:11, zlim=c(minz,maxz), col=collist, lab.breaks=breaklist, legend.width=2, smallplot= c(.87,0.93,0.05,0.85)) #, legend.args=list( text="AI",cex=1, side=4, line=1)) #use if you do the 0.8, 1.2 

```

Storage change divided by LH flux increase plot
```{r StorLH_HUC, fig.width=8.1, fig.height=8.9, warning=FALSE}
#fout=paste(plotdir, "Storage_LH_Ratio.pdf", sep="")
#pdf(fout, width=8.1, height=8.9)
par(mfrow=c(2,1), mar=c(1,2,3,3))

maxz=0.2
minz=0

#make a mask for aridity index <1
PET_Mask=rep(NA,nval)
PET_Mask[AI_Hgrid<=1.5]=1

#2 degree 
plottemp=(-stordif_Hgrid[,1])/(lhmm_Hgridtot[,2]-lhmm_Hgridtot[,1]) #year for ending storage dif/ total LH dif
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
plottemp=plottemp*PET_Mask
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightgrey',  legend=T, main="2 Degree stordif/LH dif [mm]", axes=F, zlim=c(minz, maxz))

#4 degree 
plottemp=(-stordif_Hgrid[,2])/(lhmm_Hgridtot[,3]-lhmm_Hgridtot[,1])
plottemp[which(plottemp>maxz)]=maxz
plottemp[which(plottemp<minz)]=minz
plottemp=plottemp*PET_Mask
rastertemp1=rasterFromXYZ(cbind(xUTM, yUTM, plottemp))
plot(rastertemp1, maxpixels=(nx*ny*10), col=brewer.pal(name="YlGnBu", n=10), colNA='lightgrey',  legend=T, main="2 Degree stordif/LH dif[mm]", axes=F, zlim=c(minz, maxz))

#dev.off()
```
